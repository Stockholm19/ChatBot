# Kudos Bot

## Описание проекта

Kudos Bot — это Telegram-бот, написанный на **Swift (Vapor)** и построенный по модульной архитектуре с кастомным стартовым меню. Каждая кнопка в меню представляет собой отдельную функциональную фичу (например, «Благодарности»), что позволяет легко расширять проект новыми модулями.

Основная реализованная функция — система благодарностей (Kudos): пользователи могут отправлять благодарности коллегам, просматривать статистику и экспортировать данные в CSV. Проект разворачивается через Docker и включает CI/CD пайплайн для автоматического деплоя.

---

## Основные возможности

- Приветственное меню с кнопками, без необходимости ввода команд вручную.
- Передача благодарностей коллегам через пошаговый сценарий:
  - выбор сотрудника из постраничного каталога (по 10 человек на экран),
  - ввод причины благодарности (не менее 20 символов),
  - сохранение благодарности в базе данных.
- Статистика:
  - количество отправленных благодарностей,
  - количество полученных благодарностей.
- Экспорт всех благодарностей в CSV (доступен только администраторам).
- Хранение данных в PostgreSQL.
- Полная работа в Telegram-чате без веб-интерфейса.
- Поддержка нескольких администраторов с возможностью настройки через переменную окружения.

---

## Архитектура и фичи

Проект построен по принципу feature-folder архитектуры, где каждая функциональная область изолирована в отдельный модуль.  
Ниже приведена структура директорий:

```
Sources/
├── App/
│   ├── Configuration/              # Настройка приложения и маршрутов
│   │   ├── Boot.swift              # Инициализация, миграции, сидирование
│   │   ├── Migrations/             # Миграции БД
│   │   └── Routes.swift            # Регистрация роутов
│   │
│   ├── Core/                       # Базовые сервисы и инфраструктура
│   │   ├── BotController.swift     # Роутинг апдейтов Telegram
│   │   ├── TelegramService.swift   # Транспорт: poll, sendMessage, sendDocument
│   │   ├── SessionStore.swift      # Хранилище состояний диалогов
│   │   ├── CSVExporter.swift       # Экспорт благодарностей в CSV
│   │   └── DTO.swift               # Общие DTO и вспомогательные модели
│   │
│   ├── Features/                   # Фичи (доменные модули)
│   │   ├── BotMenu/                # Меню Telegram-бота
│   │   │   ├── Controllers/
│   │   │   │   └── BotMenuController.swift
│   │   │   └── Services/
│   │   │       └── KeyboardBuilder.swift
│   │   │
│   │   ├── Employees/              # Модуль сотрудников
│   │   │   ├── Import/
│   │   │   ├── Migrations/
│   │   │   │   └── CreateEmployees.swift
│   │   │   ├── Models/
│   │   │   │   └── Employee.swift
│   │   │   └── Services/
│   │   │       └── EmployeesRepo.swift
│   │   │
│   │   └── Kudos/                  # Модуль благодарностей
│   │       └── KudosModel.swift
│   │
│   └── Run/                        # Точка входа
│       └── Main.swift
│
├── Resources/                      # Файлы сидирования и статические данные
│   └── SeedData/
│       ├── employees.csv
│       └── employees.template.csv
│
├── exports/                        # Экспортированные CSV-файлы
│
├── docker-compose.yml
├── docker-compose.prod.yml
└── Dockerfile
```

### Каталог сотрудников

- Список сотрудников загружается из CSV-файла `Resources/SeedData/employees.csv` и автоматически сохраняется в базу при первом запуске.
- Каждая запись содержит:
  - ФИО сотрудника,
  - статус активности (Да/Нет),
  - Telegram ID для связи с ботом.
- При передаче благодарности пользователь выбирает коллегу из постраничного каталога, что исключает необходимость ручного ввода `@username`.

### Связи и подсчёт статистики

- Благодарности хранятся с привязкой к сотрудникам через внешние ключи (`employee_id`, `from_employee_id`), а не просто к никам.
- Это обеспечивает корректный подсчёт статистики и экспорт данных даже при изменении никнеймов.
- При отсутствии Telegram ID используется резервный поиск по нику.
- Кнопки статистики «Сколько получил» и «Количество переданных» учитывают FK-связи.

### Экспорт CSV

- Экспортированные данные содержат ФИО отправителя и получателя, а не только их логины.
- Пример структуры CSV:

  ```
  Дата и время;От кого (логин);От кого (имя);Кому (имя);Причина
  ```

- Старые записи с `@username` продолжают корректно отображаться.
- Ручной ввод ника временно скрыт из интерфейса, но сохраняется в коде для совместимости.

---

## Данные и структура базы

- PostgreSQL база данных запускается как сервис `db` в Docker Compose и использует volume для хранения данных.
- Таблица сотрудников содержит данные из CSV-семпла.
- Таблица благодарностей хранит информацию с FK-связями на сотрудников.
- Экспортированные CSV-файлы сохраняются в папке `exports/` на хост-машине (примонтировано как `./exports:/exports`).

---

## Развёртывание

### Локальный запуск

**Требования:** Xcode 15+/Swift 5.10, Docker Desktop.

Запуск через Docker Compose:

```bash
docker compose up --build -d
docker compose logs -f
```

### Продакшен

- Развёртывание на VPS (Ubuntu 22/24) с Docker и Docker Compose.
- Папка приложения `/apps/kudos-bot`.
- Файл окружения `.env` с настройками бота, базы данных и администраторами.
- Пример `.env`:

  ```env
  BOT_TOKEN=ваш_токен_бота

  POSTGRES_DB=kudos
  POSTGRES_USER=postgres
  POSTGRES_PASSWORD=postgres
  POSTGRES_HOST=db
  POSTGRES_PORT=5432
  DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=disable

  ADMIN_IDS=12345678,12345678

  LOG_LEVEL=info
  STORAGE_DIR=/exports
  ```

- Для запуска на VPS:

  ```bash
  sudo mkdir -p /apps/kudos-bot && cd /apps/kudos-bot
  sudo nano .env  # добавить переменные окружения
  sudo chmod 600 .env
  ```

- Запуск через Docker Compose с продовым файлом:

  ```bash
  docker compose -f docker-compose.prod.yml up -d
  ```

---

## CI/CD и мониторинг

### CI/CD

- Автоматическая сборка и пуш Docker-образа в Docker Hub при пуше в ветку `main`.
- Теги образа: `latest` и SHA коммита.
- SSH-доступ к VPS для обновления контейнеров через `docker compose pull && docker compose up -d`.
- Пайплайн настроен в `.github/workflows/deploy.yml`.

### Мониторинг и healthcheck

- Эндпоинт `/health` возвращает HTTP 200 OK при успешной работе приложения.
- Используется для проверки статуса контейнера в Docker Compose и внешнего мониторинга.
- Пример команды проверки:

  ```bash
  curl -i http://127.0.0.1:8080/health
  ```

- Настройка мониторинга (например, Uptime Kuma):

  - Тип: HTTP(s)
  - URL: `http://<IP_VPS>:8080/health`
  - Метод: GET
  - Интервал: 60 секунд
  - Допустимые коды: 200–299
  - Авторизация: отсутствует

### Очистка данных в базе

Для полной очистки таблицы благодарностей и сброса счетчика ID используйте команду:

```bash
docker compose exec -it db \
  psql -U postgres -d kudos -c \
  "TRUNCATE TABLE public.kudos RESTART IDENTITY CASCADE;"
```

**Внимание:** эта операция необратима и удалит все записи.

---

## Планы развития

- Расширение функционала команд бота.
- Добавление новых фич: списки сотрудников, справочные разделы и другие модули.
- Разработка тестов для повышения качества кода.
- Улучшение интерфейса и пользовательского опыта.

---

