# AGENTS.md

Этот файл предназначен для ИИ-ассистентов и разработчиков.
Он описывает архитектуру, правила и ограничения проекта, чтобы при генерации или изменении кода не нарушались принятые договоренности.

## Общее описание проекта

Проект — Telegram-бот «Спасибо», написанный на Swift с использованием Vapor.
Бот работает только через Telegram API, веб-интерфейса нет.
Основная задача — передача и учет благодарностей между сотрудниками с хранением данных в PostgreSQL и возможностью экспорта отчетов в CSV.

Технологический стек:
- Swift 5.9+
- Vapor 4
- Fluent + PostgreSQL
- async/await
- Docker / Docker Compose

## Точки входа приложения

- `Sources/Run/Main.swift` — запуск приложения
- `Boot.swift` — основная конфигурация приложения:
  - подключение к базе данных
  - регистрация миграций
  - регистрация роутов
  - включение или отключение фоновых задач
- `Routes.swift` — HTTP-роуты (минимальные, без бизнес-логики)
- `BotController` — единая точка входа для Telegram updates

## Архитектура и структура

Используется feature-folder архитектура.

### Core
Содержит инфраструктуру и общие компоненты:
- `TelegramService` — единственная точка работы с Telegram API
- `SessionStore` — actor для хранения состояния диалогов (in-memory)
- `CSVExporter` — формирование CSV-файлов
- DTO и вспомогательные типы

В Core не должна находиться бизнес-логика конкретных фич.

### Features
Каждая фича изолирована в своей папке и может содержать:
- Controllers (обработка входных данных)
- Services (бизнес-логика)
- Models (если необходимо)

Фичи не должны напрямую зависеть друг от друга.

## Правила и ограничения

- Не добавлять бизнес-логику в `Routes.swift`
- Не обращаться к Telegram API напрямую, только через `TelegramService`
- Не использовать глобальные синглтоны
- Не хранить состояние диалога вне `SessionStore`
- Не менять формат CSV без обновления тестов
- Не использовать force unwrap (`!`).

## Работа с Telegram

- Все входящие сообщения обрабатываются через `BotController`
- Логика меню и сценариев должна быть вынесена в отдельные контроллеры или сервисы
- Отправка сообщений и файлов осуществляется только через `TelegramService`

## Экспорт CSV

- Разделитель значений — `;`
- Обязательно добавлять BOM для корректного открытия в Windows Excel
- Экранировать значения, содержащие переносы строк или разделители

## База данных и миграции

- Используется PostgreSQL
- Подключение через `DATABASE_URL` имеет приоритет
- Миграции регистрируются централизованно в `Migrations.swift`
- Тестовая среда использует отдельную базу данных

## Тестирование

- Все новые фичи должны сопровождаться тестами
- Тесты запускаются в `.testing` окружении
- Фоновые задачи и напоминания не должны запускаться в тестах
- Изменения, влияющие на экспорт или бизнес-логику, требуют обновления тестов

## Стиль кода

Код должен писаться в стиле, совместимом с Vapor 5, даже если проект временно использует Vapor 4.

Основные принципы:
- async/await first
- минимальное использование `Application` внутри бизнес-логики
- отсутствие глобального состояния
- предпочтение явных зависимостей через инициализацию
- код должен быть готов к будущей миграции на Vapor 5 без значительных изменений

Дополнительно:
- избегать устаревших паттернов Vapor 3/4
- не использовать force unwrap (`!`) и implicitly unwrapped optionals
- писать читаемый и предсказуемый код

## Назначение файла

Этот файл служит инструкцией для ИИ-моделей и разработчиков.
Он задает рамки, архитектурные правила и ожидания, которые необходимо соблюдать при работе с кодовой базой проекта.
